---
title: "Networks - CNPq Data"
output: html_notebook
---

```{r}
library(tidyverse)
library(metricshelpr)
library(tools)
library(cowplot)
library(scales)

EXTRACTED_DATA_PATH = "../../data/extracted-author-data/extracted_author_data-cnpq 18-03-2021.RData"

if (file_ext(EXTRACTED_DATA_PATH) == "csv") {
  AUTHOR_DATA = read.table(EXTRACTED_DATA_PATH, header = T, sep = ";", dec = ",")
} else if (file_ext(EXTRACTED_DATA_PATH) %in% c("RData", "Rdata")) {
  load(EXTRACTED_DATA_PATH)
}

AUTHOR_DATA = AUTHOR_DATA %>% mutate(
  ShortName = ShortName %>%
           str_replace("& Preg", "&\nPreg") %>%
           str_replace("& Surv", "&\nSurv") %>%
           str_replace("& Diag", "&\nDiag")
)

AUTHOR_DATA_PATH = "../../data/authors-cnpq-call"

# ggplot theme
ggtheme = theme_cowplot()
theme_set(ggtheme)

source("plot-functions.R")
source("net-functions.R")
```

Load bibliometric data for each author, add columns for target author, affiliation, state and region and if papers were before or after 2016.
```{r}
filenames = paste0(AUTHOR_DATA_PATH, "/", list.files(AUTHOR_DATA_PATH, "txt$"))
# i = which(filenames == paste0(AUTHOR_DATA_PATH, "/Carlos Roberto Prudencio.txt"))
# AUTHOR_NET_DATA = map_dfr(filenames[i:length(filenames)], load_biblio_geo)
AUTHOR_NET_DATA = map_dfr(filenames, load_biblio_geo)
```

When a paper appears more than once, it is a collaboration - merge the states, regions and affiliations.
```{r}
AUTHOR_NET_DATA_PRE = consolidate_biblio_rows(AUTHOR_NET_DATA %>% filter(Class == "Pre-Outbreak"))
AUTHOR_NET_DATA_POST = consolidate_biblio_rows(AUTHOR_NET_DATA %>% filter(Class == "Post-Outbreak"))
```

Build and plot each network.

#### Researchers

Collaboration between researchers, before.
```{r}
net_pre = build_network(AUTHOR_NET_DATA_PRE) %>% pull(TargetAuthor))
```

Collaboration between researchers, after (removing connections that already existed before 2016).
```{r}
net_post = build_network(AUTHOR_NET_DATA_POST %>% pull(TargetAuthor))
net_post = subtracted_network(net_pre$edgelist, net_post$edgelist, subtract_all = F)
```

Clustering and density of edges in the researchers network, before and after.
```{r}
rbind(calc_net_metrics(net_pre$net) %>% mutate(Class = "Pre-Outbreak"),
calc_net_metrics(net_post$net) %>% mutate(Class = "Post-Outbreak"))
```


#### Institutions

Collaboration between institutions, before.
```{r}
net_pre = build_network(AUTHOR_NET_DATA_PRE %>% pull(Institution))
```

Collaboration between institutions, after (removing connections that already existed before 2016).
```{r}
net_post = build_network(AUTHOR_NET_DATA_POST %>% pull(Institution))
net_post = subtracted_network(net_pre$edgelist, net_post$edgelist, subtract_all = F)
```


#### States

Collaboration between states, before.
```{r}
net_pre = build_network(AUTHOR_NET_DATA_PRE %>% pull(State))
```

Collaboration between states, after (removing connections that already existed before 2016).
```{r}
net_post = build_network(AUTHOR_NET_DATA_POST %>% pull(State))
net_post = subtracted_network(net_pre$edgelist, net_post$edgelist, subtract_all = F)
```

Matrix to show the network, state x state, sort by region.
```{r}
plot_collab_matrix(net_pre$edgelist)
plot_collab_matrix(net_post$edgelist)
```

Clustering and density of edges in the states network, before and after.
```{r}
rbind(calc_net_metrics(net_pre$net) %>% mutate(Class = "Pre-Outbreak"),
calc_net_metrics(net_post$net) %>% mutate(Class = "Post-Outbreak"))
```



#### Regions

Collaboration between regions, before.
```{r}
net_pre = build_network(AUTHOR_NET_DATA_PRE %>% pull(Region))
```

Collaboration between regions, after (removing connections that already existed before 2016).
```{r}
net_post = build_network(AUTHOR_NET_DATA_POST %>% pull(Region))
net_post = subtracted_network(net_pre$edgelist, net_post$edgelist, subtract_all = F)
```

Matrix to show the network, region x region.
```{r}
# Convert to factors to preserve all categories in the plot
lvls = unique(c(net_pre$edgelist$V1, net_pre$edgelist$V2, net_post$edgelist$V1, net_post$edgelist$V2))
net_pre$edgelist$V1 = factor(net_pre$edgelist$V1, levels = lvls)
net_pre$edgelist$V2 = factor(net_pre$edgelist$V2, levels = lvls)
net_post$edgelist$V1 = factor(net_post$edgelist$V1, levels = lvls)
net_post$edgelist$V2 = factor(net_post$edgelist$V2, levels = lvls)

plot_collab_matrix(net_pre$edgelist)
plot_collab_matrix(net_post$edgelist)
```

Clustering and density of edges in the regions network, before and after.
```{r}
rbind(calc_net_metrics(net_pre$net) %>% mutate(Class = "Pre-Outbreak"),
calc_net_metrics(net_post$net) %>% mutate(Class = "Post-Outbreak"))
```
