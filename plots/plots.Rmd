---
title: "Analysis and Plots"
output: html_notebook
---

```{r}
library(tidyverse)
library(metricshelpr)
library(tools)
library(cowplot)
library(scales)

EXTRACTED_DATA_PATH = "../../data/extracted-authors-general/extracted_author_data-general 10-02-2021.RData"

# Load data
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

if (file_ext(EXTRACTED_DATA_PATH) == "csv") {
  AUTHOR_DATA = read.table(EXTRACTED_DATA_PATH, header = T, sep = ";", dec = ",")
} else if (file_ext(EXTRACTED_DATA_PATH) == "Rdata") {
  load(EXTRACTED_DATA_PATH)
}

AUTHOR_DATA = AUTHOR_DATA %>% mutate(
  ShortName = ShortName %>%
           str_replace("& Preg", "&\nPreg") %>%
           str_replace("& Surv", "&\nSurv") %>%
           str_replace("& Diag", "&\nDiag")
)

# ggplot theme
ggtheme = theme_cowplot()
```

## Characterization of the authors who published in Zika

### Description of Most Common Journal Area before Epidemics
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "TopField", Class == "Pre-Outbreak") %>%
  mutate(Value = str_to_title(Value)) %>%
  count(Value) %>%
  filter(n > 2)

p = ggplot(DF) +
  aes(x = reorder(Value, n), y = n) +
  geom_col() +
  labs(x = "Top Journal Area for the Author", y = "Frequency") +
  coord_flip() +
  ggtheme +
  theme(axis.text.y = element_text(size = 9))
  
p
```


### Academic Age - Years Since the First Paper Record
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "Academic Age", Class == "Pre-Outbreak") %>%
  mutate(Value = 2021 - as.numeric(Value))

p = ggplot(DF) +
  aes(x = Value) +
  geom_histogram(bins = 50) +
  geom_vline(xintercept = mean(DF$Value, na.rm = T), linetype = "dashed", color = "black") +
  labs(x = "Year of First Publication", y = "Frequency") +
  scale_x_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme
  
p
```

### Total Citations, before Epidemics
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "Citations", Class == "Pre-Outbreak") %>%
  mutate(Value = as.numeric(Value))

p = ggplot(DF) +
  aes(x = Value) +
  geom_histogram(bins = 50) +
  labs(x = "Total Citations Before the Outbreak", y = "Frequency") +
  scale_x_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme
  
plog = ggplot(DF) +
  aes(x = Value) +
  geom_histogram(bins = 50) +
  labs(x = "Total Citations Before the Outbreak", y = "Frequency") +
  scale_x_continuous(breaks = c(10, 50, 200, 1000, 10000), trans = "log10") +
  ggtheme
  
list(p, plog)
```

## Changes in publication patterns after the outbreak

```{r}
# Make list of authors with at least 3 papers in each period, so that the estimates have a minimal sample size, to remove a bit of noise
selected_authors = AUTHOR_DATA %>%
  filter(ShortName == "Papers", Class %in% c("Pre-Outbreak", "Zika")) %>%
  mutate(Value = as.numeric(Value)) %>%
  pivot_wider(id_cols = Author, values_from = Value, names_from = Class) %>%
  filter(`Pre-Outbreak` > 3, Zika > 3) %>% pull(Author)
```


### Citations per Paper, before and Zika papers
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "CitationRate", Class %in% c("Pre-Outbreak", "Zika"),
         Author %in% selected_authors) %>%
  mutate(Value = as.numeric(Value))

p1 = ggplot(DF) +
  aes(x = Class, y = Value, group = Author) +
  geom_point() +
  geom_line() +
  labs(x = "Period", y = "Average # of Citations per Paper") +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme
  
p2 = ggplot(DF) +
  aes(x = Class, y = Value) +
  geom_violin() +
  labs(x = "Period", y = "Average # of Citations per Paper") +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme

list(p1,p2)
```

### Number of Authors per Paper, before and Zika papers
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "AvgAuthorNumber", Class %in% c("Pre-Outbreak", "Zika")) %>%
  mutate(Value = as.numeric(Value))

p = ggplot(DF) +
  aes(x = Class, y = Value, group = Author) +
  geom_point() +
  geom_line() +
  labs(x = "Period", y = "Average # of Authors per Paper") +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme

p
```


### Percentage of Papers with International Affiliations, before and Zika papers
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "PercPapersINTL", Class %in% c("Pre-Outbreak", "Zika"),
         Author %in% selected_authors) %>%
  mutate(Value = as.numeric(Value))
  
p = ggplot(DF) +
  aes(x = Class, y = Value, group = Author) +
  geom_point() +
  geom_line() +
  labs(x = "Period", y = "Percentage of International Collaborations") +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme
  
p
```

### Percentage of Zika-related papers post 2016
```{r}
DF = AUTHOR_DATA %>%
  filter(ShortName == "PercZika", Class == "Post-Outbreak") %>%
  mutate(Value = 100 * as.numeric(Value))

p = ggplot(DF) +
  aes(x = Value) +
  geom_histogram(bins = 50) +
  geom_vline(xintercept = mean(DF$Value, na.rm = T), linetype = "dashed", color = "black") +
  labs(x = "Percentage of Zika-related papers, post-outbreak", y = "Frequency") +
  scale_x_continuous(breaks = pretty_breaks(n = 10)) +
  ggtheme
  
p
```

## Characterization of Zika-related publications

### Frequency of MeSH Categories

```{r}
DF = AUTHOR_DATA %>% filter(ShortName %>% str_detect("MeSH"), Class == "Zika") %>%
  mutate(Value = as.numeric(Value),
         ShortName = ShortName %>% str_remove("MeSHCat - "))

plot_mesh_cats = function (DF, title = "") {
  DF = DF %>% group_by(ShortName) %>% summarise(Value = sum(Value, na.rm = T))
  ggplot(DF) +
    aes(x = ShortName, y = Value, fill = ShortName) +
    geom_col() +
    labs(x = "", y = "# of Publications", title = title) +
    scale_y_continuous(breaks = pretty_breaks(n = 5)) +
    coord_flip() +
    ggtheme +
    theme(axis.text.y = element_text(size = 10),
          legend.position = "none")
}

p = plot_mesh_cats(DF, title = "All Fields")
p

```


## Which authors published in which categories?

```{r}
AUTHORS_BY_FIELD = AUTHOR_DATA %>%
  filter(ShortName == "TopField" & Class == "Pre-Outbreak") %>%
  mutate(Field = str_to_title(Value)) %>%
  select(Author, Field)

DF = AUTHOR_DATA %>% filter(ShortName %>% str_detect("MeSH"), Class == "Zika") %>%
  mutate(Value = as.numeric(Value),
         ShortName = ShortName %>% str_remove("MeSHCat - ")) %>%
  left_join(AUTHORS_BY_FIELD, by = "Author")

top_fields = AUTHOR_DATA %>%
  filter(ShortName == "TopField", Class == "Pre-Outbreak") %>%
  mutate(Value = str_to_title(Value)) %>%
  count(Value) %>%
  filter(n >= 10) %>% pull(Value)

map(unique(top_fields), function (selected_field) {
  d = DF %>% filter(Field == selected_field)
  plot_mesh_cats(d, title = selected_field)
})

```

